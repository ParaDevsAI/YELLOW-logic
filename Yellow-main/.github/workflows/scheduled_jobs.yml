name: Scheduled Analysis Jobs

on:
  # Allows manual triggering from the Actions tab on GitHub.
  # When triggered manually, all jobs will run.
  workflow_dispatch:

  # Separate cron schedule for each job
  schedule:
    - cron: '*/30 * * * *'  # Leaderboard
    - cron: '0 */6 * * *'   # Metrics Snapshot
    - cron: '0 3 * * *'      # Cross Engagement

jobs:
  # A separate job for each script to ensure they run independently
  # and can be triggered correctly by their respective schedules.

  run_leaderboard_generator:
    name: "Run Leaderboard Generator"
    # This job runs on its specific schedule OR when manually dispatched
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '*/30 * * * *'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run Script
        run: python generate_leaderboard.py
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_LOG_CHANNEL_ID: ${{ secrets.TELEGRAM_LOG_CHANNEL_ID }}
          SCORING_BONUS_MULTIPLIER: ${{ secrets.SCORING_BONUS_MULTIPLIER }}

  run_metrics_snapshot:
    name: "Run Metrics Snapshot"
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 */6 * * *'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run Script
        run: python metrics_snapshot.py
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_LOG_CHANNEL_ID: ${{ secrets.TELEGRAM_LOG_CHANNEL_ID }}
          SCORING_BONUS_MULTIPLIER: ${{ secrets.SCORING_BONUS_MULTIPLIER }}

  run_cross_engagement_tracker:
    name: "Run Cross Engagement Tracker"
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 3 * * *'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run Script
        run: python cross_engagement_tracker.py
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_LOG_CHANNEL_ID: ${{ secrets.TELEGRAM_LOG_CHANNEL_ID }}
          SCORING_BONUS_MULTIPLIER: ${{ secrets.SCORING_BONUS_MULTIPLIER }} 