# =================================================================
# GITHUB ACTIONS WORKFLOW - YELLOW ENGAGEMENT TRACKER AUTOMATION (V2)
# =================================================================
#
# Objetivo:
# Este workflow automatiza a execução dos scripts de coleta e
# processamento de dados com as frequências específicas solicitadas.
#
# IMPORTANTE:
# Configure os seguintes "Secrets" no seu repositório do GitHub:
# - SUPABASE_URL
# - SUPABASE_KEY
# - TWITTER_API_KEY
#
name: Scheduled Data Update

on:
  # Permite a execução manual a partir da aba "Actions"
  workflow_dispatch:

  schedule:
    # Frequência 1: A cada 6 horas (para métricas de tweets recentes)
    - cron: '0 */6 * * *'
    # Frequência 2: Diariamente (para engajamentos, threads e métricas de tweets de 3-7 dias)
    - cron: '0 5 * * *' # Executa às 05:00 UTC
    # Frequência 3: Semanalmente (para métricas de tweets antigos)
    - cron: '0 6 * * 0' # Executa todo Domingo às 06:00 UTC

jobs:
  # --- Job para métricas de tweets com menos de 3 dias ---
  update-recent-metrics:
    # Executa apenas no agendamento de 6 horas
    if: github.event.schedule == '0 */6 * * *'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./YELLOW
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      - name: Install Dependencies
        run: pip install -r requirements.txt
      - name: Run metrics_snapshot for recent tweets
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        run: python metrics_snapshot.py --frequency 6_hours

  # --- Job para as tarefas diárias ---
  run-daily-tasks:
    # Executa apenas no agendamento diário
    if: github.event.schedule == '0 5 * * *'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./YELLOW
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      - name: Install Dependencies
        run: pip install -r requirements.txt
      - name: Run daily scripts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        run: |
          echo ">>> Running cross_engagement_tracker.py"
          python cross_engagement_tracker.py
          echo ">>> Running thread_identifier.py"
          python thread_identifier.py
          echo ">>> Running metrics_snapshot.py for daily frequency"
          python metrics_snapshot.py --frequency daily
          echo ">>> Rebuilding full leaderboard history..."
          python scripts/generate_leaderboard.py

  # --- Job para a tarefa semanal ---
  run-weekly-tasks:
    # Executa apenas no agendamento semanal
    if: github.event.schedule == '0 6 * * 0'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./YELLOW
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with: { python-version: '3.10' }
      - name: Install Dependencies
        run: pip install -r requirements.txt
      - name: Run metrics_snapshot for weekly frequency
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        run: python metrics_snapshot.py --frequency weekly 